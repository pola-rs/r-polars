name: Copilot Setup Steps

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
  R_KEEP_PKG_SOURCE: yes
  NOT_CRAN: "true"

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    name: Setup development environment for Copilot
    steps:
      - uses: actions/checkout@v5

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3"
          use-public-rspm: true
          Ncpus: "2"

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::devtools
            any::pkgbuild
            any::testthat
            any::lintr
            any::pkgload
          cache: "always"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - uses: rui314/setup-mold@v1

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src/rust -> target"

      - name: Install savvy-cli
        run: cargo install savvy-cli

      - name: Set environment variables
        run: |
          echo "NOT_CRAN=true" >> $GITHUB_ENV
          echo "LIBR_POLARS_BUILD=true" >> $GITHUB_ENV
          echo "DEBUG=true" >> $GITHUB_ENV

      - name: Verify setup
        run: |
          echo "R version:"
          R --version
          echo "Rust version:"
          rustc --version
          cargo --version
          echo "savvy-cli version:"
          savvy-cli --version
          echo "Environment ready for r-polars development"